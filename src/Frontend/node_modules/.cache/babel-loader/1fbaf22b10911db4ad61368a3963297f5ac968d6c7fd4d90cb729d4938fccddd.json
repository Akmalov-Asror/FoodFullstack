{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Task = exports.deepCopyForResponse = void 0;\nconst status_1 = require(\"../status\");\nconst googleError_1 = require(\"../googleError\");\n/**\n * Creates a deep copy of the object with the consideration of subresponse\n * fields for bundling.\n *\n * @param {Object} obj - The source object.\n * @param {Object?} subresponseInfo - The information to copy the subset of\n *   the field for the response. Do nothing if it's null.\n * @param {String} subresponseInfo.field - The field name.\n * @param {number} subresponseInfo.start - The offset where the copying\n *   element should starts with.\n * @param {number} subresponseInfo.end - The ending index where the copying\n *   region of the elements ends.\n * @return {Object} The copied object.\n * @private\n */\nfunction deepCopyForResponse(\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nobj, subresponseInfo) {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  let result;\n  if (obj === null) {\n    return null;\n  }\n  if (obj === undefined) {\n    return undefined;\n  }\n  if (Array.isArray(obj)) {\n    result = [];\n    obj.forEach(element => {\n      result.push(deepCopyForResponse(element, null));\n    });\n    return result;\n  }\n  // Some objects (such as ByteBuffer) have copy method.\n  if (obj.copy !== undefined) {\n    return obj.copy();\n  }\n  // ArrayBuffer should be copied through slice().\n  if (obj instanceof ArrayBuffer) {\n    return obj.slice(0);\n  }\n  if (typeof obj === 'object') {\n    result = {};\n    Object.keys(obj).forEach(key => {\n      if (subresponseInfo && key === subresponseInfo.field && Array.isArray(obj[key])) {\n        // Note that subresponses are not deep-copied. This is safe because\n        // those subresponses are not shared among callbacks.\n        result[key] = obj[key].slice(subresponseInfo.start, subresponseInfo.end);\n      } else {\n        result[key] = deepCopyForResponse(obj[key], null);\n      }\n    });\n    return result;\n  }\n  return obj;\n}\nexports.deepCopyForResponse = deepCopyForResponse;\nclass Task {\n  /**\n   * A task coordinates the execution of a single bundle.\n   *\n   * @param {function} apiCall - The function to conduct calling API.\n   * @param {Object} bundlingRequest - The base request object to be used\n   *   for the actual API call.\n   * @param {string} bundledField - The name of the field in bundlingRequest\n   *   to be bundled.\n   * @param {string=} subresponseField - The name of the field in the response\n   *   to be passed to the callback.\n   * @constructor\n   * @private\n   */\n  constructor(apiCall, bundlingRequest, bundledField, subresponseField) {\n    this._apiCall = apiCall;\n    this._request = bundlingRequest;\n    this._bundledField = bundledField;\n    this._subresponseField = subresponseField;\n    this._data = [];\n  }\n  /**\n   * Returns the number of elements in a task.\n   * @return {number} The number of elements.\n   */\n  getElementCount() {\n    let count = 0;\n    for (let i = 0; i < this._data.length; ++i) {\n      count += this._data[i].elements.length;\n    }\n    return count;\n  }\n  /**\n   * Returns the total byte size of the elements in a task.\n   * @return {number} The byte size.\n   */\n  getRequestByteSize() {\n    let size = 0;\n    for (let i = 0; i < this._data.length; ++i) {\n      size += this._data[i].bytes;\n    }\n    return size;\n  }\n  /**\n   * Invokes the actual API call with current elements.\n   * @return {string[]} - the list of ids for invocations to be run.\n   */\n  run() {\n    if (this._data.length === 0) {\n      return [];\n    }\n    const request = this._request;\n    const elements = [];\n    const ids = [];\n    for (let i = 0; i < this._data.length; ++i) {\n      elements.push(...this._data[i].elements);\n      ids.push(this._data[i].callback.id);\n    }\n    request[this._bundledField] = elements;\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\n    const self = this;\n    this.callCanceller = this._apiCall(request, (err, response) => {\n      const responses = [];\n      if (err) {\n        self._data.forEach(() => {\n          responses.push(undefined);\n        });\n      } else {\n        let subresponseInfo = null;\n        if (self._subresponseField) {\n          subresponseInfo = {\n            field: self._subresponseField,\n            start: 0\n          };\n        }\n        self._data.forEach(data => {\n          if (subresponseInfo) {\n            subresponseInfo.end = subresponseInfo.start + data.elements.length;\n          }\n          responses.push(deepCopyForResponse(response, subresponseInfo));\n          if (subresponseInfo) {\n            subresponseInfo.start = subresponseInfo.end;\n          }\n        });\n      }\n      for (let i = 0; i < self._data.length; ++i) {\n        if (self._data[i].cancelled) {\n          const error = new googleError_1.GoogleError('cancelled');\n          error.code = status_1.Status.CANCELLED;\n          self._data[i].callback(error);\n        } else {\n          self._data[i].callback(err, responses[i]);\n        }\n      }\n    });\n    return ids;\n  }\n  /**\n   * Appends the list of elements into the task.\n   * @param {Object[]} elements - the new list of elements.\n   * @param {number} bytes - the byte size required to encode elements in the API.\n   * @param {APICallback} callback - the callback of the method call.\n   */\n  extend(elements, bytes, callback) {\n    this._data.push({\n      elements,\n      bytes,\n      callback\n    });\n  }\n  /**\n   * Cancels a part of elements.\n   * @param {string} id - The identifier of the part of elements.\n   * @return {boolean} Whether the entire task will be canceled or not.\n   */\n  cancel(id) {\n    if (this.callCanceller) {\n      let allCancelled = true;\n      this._data.forEach(d => {\n        if (d.callback.id === id) {\n          d.cancelled = true;\n        }\n        if (!d.cancelled) {\n          allCancelled = false;\n        }\n      });\n      if (allCancelled) {\n        this.callCanceller.cancel();\n      }\n      return allCancelled;\n    }\n    for (let i = 0; i < this._data.length; ++i) {\n      if (this._data[i].callback.id === id) {\n        const error = new googleError_1.GoogleError('cancelled');\n        error.code = status_1.Status.CANCELLED;\n        this._data[i].callback(error);\n        this._data.splice(i, 1);\n        break;\n      }\n    }\n    return this._data.length === 0;\n  }\n}\nexports.Task = Task;","map":{"version":3,"names":["status_1","require","googleError_1","deepCopyForResponse","obj","subresponseInfo","result","undefined","Array","isArray","forEach","element","push","copy","ArrayBuffer","slice","Object","keys","key","field","start","end","exports","Task","constructor","apiCall","bundlingRequest","bundledField","subresponseField","_apiCall","_request","_bundledField","_subresponseField","_data","getElementCount","count","i","length","elements","getRequestByteSize","size","bytes","run","request","ids","callback","id","self","callCanceller","err","response","responses","data","cancelled","error","GoogleError","code","Status","CANCELLED","extend","cancel","allCancelled","d","splice"],"sources":["../../../src/bundlingCalls/task.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}