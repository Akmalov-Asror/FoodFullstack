{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2021 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.decodeResponse = exports.encodeRequest = void 0;\n// proto-over-HTTP request encoding and decoding\nconst serializer = require(\"proto3-json-serializer\");\nconst fallback_1 = require(\"./fallback\");\nconst featureDetection_1 = require(\"./featureDetection\");\nconst googleError_1 = require(\"./googleError\");\nconst transcoding_1 = require(\"./transcoding\");\nif (!featureDetection_1.hasTextEncoder() || !featureDetection_1.hasTextDecoder()) {\n  if (featureDetection_1.isNodeJS()) {\n    // Node.js 10 does not have global TextDecoder\n    // TODO(@alexander-fenster): remove this logic after Node.js 10 is EOL.\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const util = require('util');\n    Object.assign(global, {\n      TextDecoder: util.TextDecoder,\n      TextEncoder: util.TextEncoder\n    });\n  } else {\n    require('fast-text-encoding');\n  }\n}\nfunction encodeRequest(rpc, protocol, servicePath, servicePort, request) {\n  const headers = {\n    'Content-Type': 'application/json'\n  };\n  const message = rpc.resolvedRequestType.fromObject(request);\n  const json = serializer.toProto3JSON(message);\n  if (!json) {\n    throw new Error(`Cannot send null request to RPC ${rpc.name}.`);\n  }\n  if (typeof json !== 'object' || Array.isArray(json)) {\n    throw new Error(`Request to RPC ${rpc.name} must be an object.`);\n  }\n  const transcoded = transcoding_1.transcode(json, rpc.parsedOptions, rpc.resolvedRequestType.fields);\n  if (!transcoded) {\n    throw new Error(`Cannot build HTTP request for ${JSON.stringify(json)}, method: ${rpc.name}`);\n  }\n  const method = transcoded.httpMethod;\n  const body = JSON.stringify(transcoded.data);\n  const url = `${protocol}://${servicePath}:${servicePort}/${transcoded.url.replace(/^\\//, '')}?${transcoded.queryString}`;\n  return {\n    method,\n    url,\n    headers,\n    body\n  };\n}\nexports.encodeRequest = encodeRequest;\nfunction decodeResponse(rpc, ok, response) {\n  // eslint-disable-next-line node/no-unsupported-features/node-builtins\n  const decodedString = new TextDecoder().decode(response);\n  const json = JSON.parse(decodedString);\n  if (!ok) {\n    const error = googleError_1.GoogleError.parseHttpError(json);\n    throw error;\n  }\n  const message = serializer.fromProto3JSON(rpc.resolvedResponseType, json);\n  if (!message) {\n    throw new Error(`Received null response from RPC ${rpc.name}`);\n  }\n  return rpc.resolvedResponseType.toObject(message, fallback_1.defaultToObjectOptions);\n}\nexports.decodeResponse = decodeResponse;","map":{"version":3,"names":["serializer","require","fallback_1","featureDetection_1","googleError_1","transcoding_1","hasTextEncoder","hasTextDecoder","isNodeJS","util","Object","assign","global","TextDecoder","TextEncoder","encodeRequest","rpc","protocol","servicePath","servicePort","request","headers","message","resolvedRequestType","fromObject","json","toProto3JSON","Error","name","Array","isArray","transcoded","transcode","parsedOptions","fields","JSON","stringify","method","httpMethod","body","data","url","replace","queryString","exports","decodeResponse","ok","response","decodedString","decode","parse","error","GoogleError","parseHttpError","fromProto3JSON","resolvedResponseType","toObject","defaultToObjectOptions"],"sources":["../../src/fallbackRest.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}