{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nconst net_1 = __importDefault(require(\"net\"));\nconst tls_1 = __importDefault(require(\"tls\"));\nconst url_1 = __importDefault(require(\"url\"));\nconst assert_1 = __importDefault(require(\"assert\"));\nconst debug_1 = __importDefault(require(\"debug\"));\nconst agent_base_1 = require(\"agent-base\");\nconst parse_proxy_response_1 = __importDefault(require(\"./parse-proxy-response\"));\nconst debug = debug_1.default('https-proxy-agent:agent');\n/**\n * The `HttpsProxyAgent` implements an HTTP Agent subclass that connects to\n * the specified \"HTTP(s) proxy server\" in order to proxy HTTPS requests.\n *\n * Outgoing HTTP requests are first tunneled through the proxy server using the\n * `CONNECT` HTTP request method to establish a connection to the proxy server,\n * and then the proxy server connects to the destination target and issues the\n * HTTP request from the proxy server.\n *\n * `https:` requests have their socket connection upgraded to TLS once\n * the connection to the proxy server has been established.\n *\n * @api public\n */\nclass HttpsProxyAgent extends agent_base_1.Agent {\n  constructor(_opts) {\n    let opts;\n    if (typeof _opts === 'string') {\n      opts = url_1.default.parse(_opts);\n    } else {\n      opts = _opts;\n    }\n    if (!opts) {\n      throw new Error('an HTTP(S) proxy server `host` and `port` must be specified!');\n    }\n    debug('creating new HttpsProxyAgent instance: %o', opts);\n    super(opts);\n    const proxy = Object.assign({}, opts);\n    // If `true`, then connect to the proxy server over TLS.\n    // Defaults to `false`.\n    this.secureProxy = opts.secureProxy || isHTTPS(proxy.protocol);\n    // Prefer `hostname` over `host`, and set the `port` if needed.\n    proxy.host = proxy.hostname || proxy.host;\n    if (typeof proxy.port === 'string') {\n      proxy.port = parseInt(proxy.port, 10);\n    }\n    if (!proxy.port && proxy.host) {\n      proxy.port = this.secureProxy ? 443 : 80;\n    }\n    // ALPN is supported by Node.js >= v5.\n    // attempt to negotiate http/1.1 for proxy servers that support http/2\n    if (this.secureProxy && !('ALPNProtocols' in proxy)) {\n      proxy.ALPNProtocols = ['http 1.1'];\n    }\n    if (proxy.host && proxy.path) {\n      // If both a `host` and `path` are specified then it's most likely\n      // the result of a `url.parse()` call... we need to remove the\n      // `path` portion so that `net.connect()` doesn't attempt to open\n      // that as a Unix socket file.\n      delete proxy.path;\n      delete proxy.pathname;\n    }\n    this.proxy = proxy;\n  }\n  /**\n   * Called when the node-core HTTP client library is creating a\n   * new HTTP request.\n   *\n   * @api protected\n   */\n  callback(req, opts) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const {\n        proxy,\n        secureProxy\n      } = this;\n      // Create a socket connection to the proxy server.\n      let socket;\n      if (secureProxy) {\n        debug('Creating `tls.Socket`: %o', proxy);\n        socket = tls_1.default.connect(proxy);\n      } else {\n        debug('Creating `net.Socket`: %o', proxy);\n        socket = net_1.default.connect(proxy);\n      }\n      const headers = Object.assign({}, proxy.headers);\n      const hostname = `${opts.host}:${opts.port}`;\n      let payload = `CONNECT ${hostname} HTTP/1.1\\r\\n`;\n      // Inject the `Proxy-Authorization` header if necessary.\n      if (proxy.auth) {\n        headers['Proxy-Authorization'] = `Basic ${Buffer.from(proxy.auth).toString('base64')}`;\n      }\n      // The `Host` header should only include the port\n      // number when it is not the default port.\n      let {\n        host,\n        port,\n        secureEndpoint\n      } = opts;\n      if (!isDefaultPort(port, secureEndpoint)) {\n        host += `:${port}`;\n      }\n      headers.Host = host;\n      headers.Connection = 'close';\n      for (const name of Object.keys(headers)) {\n        payload += `${name}: ${headers[name]}\\r\\n`;\n      }\n      const proxyResponsePromise = parse_proxy_response_1.default(socket);\n      socket.write(`${payload}\\r\\n`);\n      const {\n        statusCode,\n        buffered\n      } = yield proxyResponsePromise;\n      if (statusCode === 200) {\n        req.once('socket', resume);\n        if (opts.secureEndpoint) {\n          // The proxy is connecting to a TLS server, so upgrade\n          // this socket connection to a TLS connection.\n          debug('Upgrading socket connection to TLS');\n          const servername = opts.servername || opts.host;\n          return tls_1.default.connect(Object.assign(Object.assign({}, omit(opts, 'host', 'hostname', 'path', 'port')), {\n            socket,\n            servername\n          }));\n        }\n        return socket;\n      }\n      // Some other status code that's not 200... need to re-play the HTTP\n      // header \"data\" events onto the socket once the HTTP machinery is\n      // attached so that the node core `http` can parse and handle the\n      // error status code.\n      // Close the original socket, and a new \"fake\" socket is returned\n      // instead, so that the proxy doesn't get the HTTP request\n      // written to it (which may contain `Authorization` headers or other\n      // sensitive data).\n      //\n      // See: https://hackerone.com/reports/541502\n      socket.destroy();\n      const fakeSocket = new net_1.default.Socket({\n        writable: false\n      });\n      fakeSocket.readable = true;\n      // Need to wait for the \"socket\" event to re-play the \"data\" events.\n      req.once('socket', s => {\n        debug('replaying proxy buffer for failed request');\n        assert_1.default(s.listenerCount('data') > 0);\n        // Replay the \"buffered\" Buffer onto the fake `socket`, since at\n        // this point the HTTP module machinery has been hooked up for\n        // the user.\n        s.push(buffered);\n        s.push(null);\n      });\n      return fakeSocket;\n    });\n  }\n}\nexports.default = HttpsProxyAgent;\nfunction resume(socket) {\n  socket.resume();\n}\nfunction isDefaultPort(port, secure) {\n  return Boolean(!secure && port === 80 || secure && port === 443);\n}\nfunction isHTTPS(protocol) {\n  return typeof protocol === 'string' ? /^https:?$/i.test(protocol) : false;\n}\nfunction omit(obj, ...keys) {\n  const ret = {};\n  let key;\n  for (key in obj) {\n    if (!keys.includes(key)) {\n      ret[key] = obj[key];\n    }\n  }\n  return ret;\n}","map":{"version":3,"names":["net_1","__importDefault","require","tls_1","url_1","assert_1","debug_1","agent_base_1","parse_proxy_response_1","debug","default","HttpsProxyAgent","Agent","constructor","_opts","opts","parse","Error","proxy","Object","assign","secureProxy","isHTTPS","protocol","host","hostname","port","parseInt","ALPNProtocols","path","pathname","callback","req","socket","connect","headers","payload","auth","Buffer","from","toString","secureEndpoint","isDefaultPort","Host","Connection","name","keys","proxyResponsePromise","write","statusCode","buffered","once","resume","servername","omit","destroy","fakeSocket","Socket","writable","readable","s","listenerCount","push","exports","secure","Boolean","test","obj","ret","key","includes"],"sources":["../src/agent.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}