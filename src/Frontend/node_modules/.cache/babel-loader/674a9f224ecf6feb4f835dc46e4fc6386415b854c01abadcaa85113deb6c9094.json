{"ast":null,"code":"\"use strict\";\n\n/**\n * Copyright 2020 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.GoogleErrorDecoder = exports.GoogleError = void 0;\nconst status_1 = require(\"./status\");\nconst protobuf = require(\"protobufjs\");\nclass GoogleError extends Error {\n  // Parse details field in google.rpc.status wire over gRPC medatadata.\n  // Promote google.rpc.ErrorInfo if exist.\n  static parseGRPCStatusDetails(err) {\n    const decoder = new GoogleErrorDecoder();\n    try {\n      if (err.metadata && err.metadata.get('grpc-status-details-bin')) {\n        const statusDetailsObj = decoder.decodeGRPCStatusDetails(err.metadata.get('grpc-status-details-bin'));\n        if (statusDetailsObj && statusDetailsObj.details && statusDetailsObj.details.length > 0) {\n          err.statusDetails = statusDetailsObj.details;\n        }\n        if (statusDetailsObj && statusDetailsObj.errorInfo) {\n          err.reason = statusDetailsObj.errorInfo.reason;\n          err.domain = statusDetailsObj.errorInfo.domain;\n          err.errorInfoMetadata = statusDetailsObj.errorInfo.metadata;\n        }\n      }\n    } catch (decodeErr) {\n      // ignoring the error\n    }\n    return err;\n  }\n  // Parse http JSON error and promote google.rpc.ErrorInfo if exist.\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  static parseHttpError(json) {\n    const error = Object.assign(new GoogleError(json['error']['message']), json.error);\n    // Map Http Status Code to gRPC Status Code\n    if (json['error']['code']) {\n      error.code = status_1.rpcCodeFromHttpStatusCode(json['error']['code']);\n    }\n    // Keep consistency with gRPC statusDetails fields. gRPC details has been occupied before.\n    // Rename \"detials\" to \"statusDetails\".\n    error.statusDetails = json['error']['details'];\n    delete error.details;\n    // Promote the ErrorInfo fields as error's top-level.\n    const errorInfo = !json['error']['details'] ? undefined : json['error']['details'].find(item => item['@type'] === 'type.googleapis.com/google.rpc.ErrorInfo');\n    if (errorInfo) {\n      error.reason = errorInfo.reason;\n      error.domain = errorInfo.domain;\n      // error.metadata has been occupied for gRPC metadata, so we use\n      // errorInfoMetadat to represent ErrorInfo' metadata field. Keep\n      // consistency with gRPC ErrorInfo metadata field name.\n      error.errorInfoMetadata = errorInfo.metadata;\n    }\n    return error;\n  }\n}\nexports.GoogleError = GoogleError;\nclass GoogleErrorDecoder {\n  constructor() {\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const errorProtoJson = require('../../protos/status.json');\n    this.root = protobuf.Root.fromJSON(errorProtoJson);\n    this.anyType = this.root.lookupType('google.protobuf.Any');\n    this.statusType = this.root.lookupType('google.rpc.Status');\n  }\n  decodeProtobufAny(anyValue) {\n    const match = anyValue.type_url.match(/^type.googleapis.com\\/(.*)/);\n    if (!match) {\n      throw new Error(`Unknown type encoded in google.protobuf.any: ${anyValue.type_url}`);\n    }\n    const typeName = match[1];\n    const type = this.root.lookupType(typeName);\n    if (!type) {\n      throw new Error(`Cannot lookup type ${typeName}`);\n    }\n    return type.decode(anyValue.value);\n  }\n  // Decodes gRPC-fallback error which is an instance of google.rpc.Status.\n  decodeRpcStatus(buffer) {\n    const uint8array = new Uint8Array(buffer);\n    const status = this.statusType.decode(uint8array);\n    // google.rpc.Status contains an array of google.protobuf.Any\n    // which need a special treatment\n    const details = [];\n    let errorInfo;\n    for (const detail of status.details) {\n      try {\n        const decodedDetail = this.decodeProtobufAny(detail);\n        details.push(decodedDetail);\n        if (detail.type_url === 'type.googleapis.com/google.rpc.ErrorInfo') {\n          errorInfo = decodedDetail;\n        }\n      } catch (err) {\n        // cannot decode detail, likely because of the unknown type - just skip it\n      }\n    }\n    const result = {\n      code: status.code,\n      message: status.message,\n      statusDetails: details,\n      reason: errorInfo === null || errorInfo === void 0 ? void 0 : errorInfo.reason,\n      domain: errorInfo === null || errorInfo === void 0 ? void 0 : errorInfo.domain,\n      errorInfoMetadata: errorInfo === null || errorInfo === void 0 ? void 0 : errorInfo.metadata\n    };\n    return result;\n  }\n  // Construct an Error from a StatusObject.\n  // Adapted from https://github.com/grpc/grpc-node/blob/main/packages/grpc-js/src/call.ts#L79\n  callErrorFromStatus(status) {\n    status.message = `${status.code} ${status_1.Status[status.code]}: ${status.message}`;\n    return Object.assign(new GoogleError(status.message), status);\n  }\n  // Decodes gRPC-fallback error which is an instance of google.rpc.Status,\n  // and puts it into the object similar to gRPC ServiceError object.\n  decodeErrorFromBuffer(buffer) {\n    return this.callErrorFromStatus(this.decodeRpcStatus(buffer));\n  }\n  // Decodes gRPC metadata error details which is an instance of google.rpc.Status.\n  decodeGRPCStatusDetails(bufferArr) {\n    const details = [];\n    let errorInfo;\n    bufferArr.forEach(buffer => {\n      const uint8array = new Uint8Array(buffer);\n      const rpcStatus = this.statusType.decode(uint8array);\n      for (const detail of rpcStatus.details) {\n        try {\n          const decodedDetail = this.decodeProtobufAny(detail);\n          details.push(decodedDetail);\n          if (detail.type_url === 'type.googleapis.com/google.rpc.ErrorInfo') {\n            errorInfo = decodedDetail;\n          }\n        } catch (err) {\n          // cannot decode detail, likely because of the unknown type - just skip it\n        }\n      }\n    });\n    const result = {\n      details,\n      errorInfo\n    };\n    return result;\n  }\n}\nexports.GoogleErrorDecoder = GoogleErrorDecoder;","map":{"version":3,"names":["status_1","require","protobuf","GoogleError","Error","parseGRPCStatusDetails","err","decoder","GoogleErrorDecoder","metadata","get","statusDetailsObj","decodeGRPCStatusDetails","details","length","statusDetails","errorInfo","reason","domain","errorInfoMetadata","decodeErr","parseHttpError","json","error","Object","assign","code","rpcCodeFromHttpStatusCode","undefined","find","item","exports","constructor","errorProtoJson","root","Root","fromJSON","anyType","lookupType","statusType","decodeProtobufAny","anyValue","match","type_url","typeName","type","decode","value","decodeRpcStatus","buffer","uint8array","Uint8Array","status","detail","decodedDetail","push","result","message","callErrorFromStatus","Status","decodeErrorFromBuffer","bufferArr","forEach","rpcStatus"],"sources":["../../src/googleError.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}